# trade_mini.py 使用说明

## 概述

`trade_mini.py` 是一个基于 miniQMT 的独立运行交易策略脚本。它不依赖 QMT 的策略运行框架，可以作为独立的 Python 程序运行，实现自动化股票交易。

## 主要功能

### 1. 核心交易逻辑
- ✅ **夜间挂单** (21:00)：为候选股票挂次日涨停价买单
- ✅ **晨间校验** (09:25)：检查前一晚挂单是否成功，失败则补充挂单
- ✅ **实时止盈止损**：通过订阅模式实时监控持仓，触发条件自动卖出
  - 止盈：收益率 ≥ 10%
  - 止损：收益率 ≤ -2%
  - 采用订阅模式，只订阅候选股票和持仓股票，实时响应行情变化

### 2. 风控机制
- ✅ **订单缓存**：防止同一股票重复挂单
- ✅ **资金管理**：预留安全垫和手续费
- ✅ **涨停保护**：止盈时若股票涨停，暂不卖出等待继续上涨
- ✅ **板块适配**：自动识别不同板块的涨停幅度（主板10%、创业板/科创板20%等）

### 3. 系统特性
- ✅ **独立运行**：无需 QMT 策略框架
- ✅ **定时任务**：基于 schedule 库的精确调度（夜间挂单和晨间校验）
- ✅ **订阅模式**：实时行情订阅，智能订阅列表管理
- ✅ **连接监控**：自动处理连接断开和重连
- ✅ **日志输出**：详细的交易日志和状态反馈
- ✅ **优雅退出**：支持 Ctrl+C 优雅退出

### 4. 订阅模式优势
- 📡 **智能订阅**：只订阅候选股票和持仓股票，避免无效订阅
- ⚡ **实时响应**：行情数据实时推送，止盈止损即时触发
- 🔄 **动态管理**：持仓变化时自动更新订阅列表
- 💡 **高效节能**：避免每秒查询，降低系统负载

## 环境要求

```bash
Python 3.6+
xtquant >= 1.0.0
xtdata >= 1.0.0
schedule >= 1.0.0
```

安装依赖：
```bash
pip install xtquant xtdata schedule
```

## 配置说明

### 1. 修改 miniQMT 路径

编辑 `trade_mini.py`，修改以下配置：

```python
# miniQMT 连接路径（需要根据实际情况修改）
MINIQMT_PATH = 'D:\\迅投极速交易终端 睿智融科版\\userdata_mini'

# 会话ID（不同策略使用不同ID）
SESSION_ID = 123456
```

### 2. 配置账号ID

支持三种方式（按优先级）：

**方式一：JSON 配置文件（推荐）**
```bash
mkdir config
```

创建 `config/trade_config.json`：
```json
{
  "account_id": "您的资金账号ID"
}
```

**方式二：文本文件**
创建 `account_id.txt`：
```
您的资金账号ID
```

**方式三：环境变量**
```bash
set ACCOUNT_ID=您的资金账号ID
```

### 3. 准备候选股票数据

确保 `data/candidate.json` 文件存在，格式如下：

```json
{
  "candidates": [
    "600000.SH",
    "000001.SZ",
    "300001.SZ"
  ],
  "timestamp": 1640995200000
}
```

## 运行方式

### 直接运行

```bash
python trade_mini.py
```

### 作为后台服务运行

**Linux/Mac:**
```bash
nohup python trade_mini.py > trade_mini.log 2>&1 &
```

**Windows:**
```cmd
start /B python trade_mini.py > trade_mini.log 2>&1
```

### 使用 PM2 运行（推荐）

```bash
npm install -g pm2
pm2 start trade_mini.py --interpreter python
pm2 save
pm2 startup
```

## 程序逻辑

### 主程序流程

```
启动 → 加载配置 → 连接 miniQMT → 设置定时任务 → 启动行情线程 → 主循环
  ↓
主循环：
  ├─ 行情线程：订阅模式实时监控 → 止盈止损
  ├─ 每分钟：更新订阅列表（候选+持仓）
  ├─ 每天 21:00：夜间挂单任务
  └─ 每天 09:25：晨间校验任务
```

### 夜间挂单流程

1. 读取候选股票列表
2. 获取可用资金
3. 计算单票仓位（预留5%安全垫）
4. 遍历候选股票：
   - 检查是否已挂单（防重复）
   - 获取昨收价，计算涨停价
   - 计算买入数量（下单100整数倍）
   - 挂买单
   - 标记已挂单

### 晨间校验流程

1. 读取候选股票列表
2. 查询当前持仓
3. 对比持仓 vs 候选股票，找出未成功买入的
4. 为未成功买入的股票补充挂单

### 止盈止损流程（订阅模式）

实时执行（通过行情数据回调）：
1. **订阅列表**：候选股票 + 当前持仓股票
2. **行情回调**：接收实时分笔数据
3. **检查持仓**：查询该股票持仓信息
4. **计算收益**：基于成本价和当前价
5. **判断条件**：
   - 收益率 ≥ 10% → 止盈卖出（除非涨停）
   - 收益率 ≤ -2% → 止损卖出
6. **动态更新**：持仓变化时自动更新订阅列表

## 涨停幅度规则

| 板块 | 代码前缀 | 涨停幅度 |
|------|----------|----------|
| 主板 | 000, 600, 601, 603, 605, 688 | 10% |
| 创业板 | 300 | 20% |
| 科创板 | 68 | 20% |
| 北交所 | 8, 4, 92 | 30% |
| ST股票 | st, *ST | 5% |

## 日志输出

程序会输出详细的日志信息：

```
🚀 miniQMT 独立交易策略启动
============================================================

📋 初始化订单缓存...
✓ 订单缓存已加载，已记录 0 条历史订单

👤 加载交易账号...
✓ 从配置文件读取账号ID: config/trade_config.json

📡 初始化行情模块...
✓ miniQMT 路径: D:\迅投极速交易终端 睿智融科版\userdata_mini

🔌 连接交易模块...
✓ 交易连接成功
✓ 账号订阅成功: 1000000365

⏰ 设置定时任务...
✓ 定时任务已设置:
  - 夜间挂单任务: 每天 21:00
  - 晨间校验任务: 每天 09:25

🔄 开始主循环...
------------------------------------------------------------
```

交易日志示例：
```
✅ 成交回报: 600000.SH 成交价:10.50 数量:1000
📊 持仓变动: 600000.SH 数量:1000
🔄 新增订阅 3 只股票: ['600000.SH', '000001.SZ', '300001.SZ']
📡 当前订阅 5 只股票
触发止盈: 600000.SH, 收益率 12.50%
执行卖出: 600000.SH, 价格 10.50, 数量 1000, 原因: 止盈卖出
✓ 卖出委托成功，订单号: 12345
```

## 文件结构

```
lcyquant/
├── trade_mini.py              # 主程序
├── config/
│   └── trade_config.json      # 账号配置文件
├── account_id.txt             # 账号ID文本文件（可选）
├── data/
│   ├── candidate.json         # 候选股票列表
│   └── order_cache.json       # 订单缓存（自动生成）
└── logs/
    └── trade_mini.log         # 运行日志
```

## 常见问题

### Q1: 提示"未找到账号ID配置"

**A:** 请检查配置文件：
- `config/trade_config.json` 是否存在且格式正确
- `account_id.txt` 是否存在且包含账号ID
- 环境变量 `ACCOUNT_ID` 是否设置

### Q2: 连接 miniQMT 失败

**A:** 请检查：
1. miniQMT 客户端是否已启动
2. `MINIQMT_PATH` 路径是否正确
3. miniQMT 版本是否兼容

### Q3: 无法获取行情数据

**A:** 请检查：
1. miniQMT 是否已下载相关股票的历史数据
2. 候选股票代码格式是否正确（如 600000.SH）
3. 网络连接是否正常

### Q4: 挂单失败

**A:** 可能原因：
1. 资金不足（可用资金 < 买入所需金额）
2. 股票停牌或涨跌停
3. 不在交易时间内
4. 账号权限不足

### Q5: 订阅模式如何工作

**A:** 订阅模式特点：
1. **智能订阅列表**：自动订阅候选股票和持仓股票
2. **实时行情推送**：通过回调函数实时接收行情数据
3. **动态更新**：持仓变化时自动调整订阅列表
4. **高效节能**：避免每秒查询，只订阅需要的股票

### Q6: 如何修改止盈止损比例

**A:** 编辑 `TRADE_PARAMS` 字典：

```python
TRADE_PARAMS = {
    'stop_profit': 0.10,  # 止盈比例 10%
    'stop_loss': -0.02,   # 止损比例 -2%
    'safety_margin': 0.05,  # 安全垫比例 5%
    'transaction_cost_rate': 0.003,  # 手续费率 0.3%
}
```

## 注意事项

⚠️ **风险提示**
1. 本程序仅供学习和研究使用，不构成投资建议
2. 实际交易前请充分测试，谨慎使用
3. 自动化交易有风险，请合理控制仓位
4. 建议在模拟环境先行验证

⚠️ **使用限制**
1. 需要稳定的网络连接
2. miniQMT 客户端需要保持运行
3. 交易时间外程序会空闲等待
4. 建议使用监控工具确保程序稳定运行

## 更新日志

### v2.0.0 (2024-12-23)
- ✅ **重大更新**：止盈止损改为订阅模式
- ✅ 实现智能订阅列表管理（候选股票 + 持仓股票）
- ✅ 优化系统性能，避免每秒查询
- ✅ 添加动态订阅列表更新机制
- ✅ 提升实时响应能力

### v1.0.0 (2024-12-23)
- ✅ 初始版本发布
- ✅ 实现夜间挂单功能
- ✅ 实现晨间校验功能
- ✅ 实现实时止盈止损
- ✅ 支持独立运行模式

## 技术支持

如有问题，请：
1. 检查日志输出
2. 查阅 miniQMT 官方文档
3. 参考 `docs/xttrader.md` 和 `docs/xtdata.md`

## 许可证

本项目仅供学习和研究使用。
