# 全量股票数据下载脚本使用指南

## 脚本功能

`download_all_stocks.py` 是一个稳定、高效的沪深A股全量历史数据下载工具，支持：

- ✅ 下载沪深A股所有股票的历史数据
- ✅ 命令行参数灵活指定日期范围
- ✅ 默认下载近70个交易日数据
- ✅ 实时进度条显示下载进度
- ✅ 断点续传功能（中断后可从上次位置继续）
- ✅ 自动重连机制（QMT连接断开时自动重连）
- ✅ 详细的日志记录
- ✅ 批量下载优化（提高效率）

## 快速开始

### 1. 基本使用（下载近70个交易日数据）

```bash
python download_all_stocks.py
```

### 2. 指定日期范围

```bash
# 下载2024年全年数据
python download_all_stocks.py --start 20240101 --end 20241231

# 下载近30个交易日数据
python download_all_stocks.py --days 30
```

### 3. 断点续传

如果下载过程中断，下次启动时添加 `--resume` 参数可从中断位置继续：

```bash
python download_all_stocks.py --resume
```

### 4. 自定义参数

```bash
# 下载近100个交易日，1分钟线数据，重试5次，间隔0.2秒
python download_all_stocks.py --days 100 --period 1m --retry 5 --delay 0.2

# 批次大小设为100（一次下载100只股票）
python download_all_stocks.py --batch-size 100
```

## 命令行参数详解

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--start` | str | 无 | 开始日期，格式：YYYYMMDD（例如：20240101） |
| `--end` | str | 无 | 结束日期，格式：YYYYMMDD（例如：20241231） |
| `--days` | int | 无 | 近N个交易日数据（默认70） |
| `--period` | str | 1d | 数据周期：1m, 5m, 15m, 30m, 1h, 1d |
| `--resume` | flag | False | 断点续传模式 |
| `--retry` | int | 3 | 下载失败重试次数 |
| `--delay` | float | 0.1 | 下载间隔秒数（避免请求过快） |
| `--batch-size` | int | 50 | 每批次下载股票数量 |
| `--log-file` | str | download_all_stocks.log | 日志文件名 |

**注意：`--start` 和 `--end` 同时指定时优先使用；否则使用 `--days`；如果都没有指定，默认使用70个交易日。**

## 数据周期说明

- `1m` - 1分钟线
- `5m` - 5分钟线
- `15m` - 15分钟线
- `30m` - 30分钟线
- `1h` - 1小时线
- `1d` - 日线（默认）

## 进度条显示

下载过程中会显示详细的进度条：

```
下载进度: 100%|██████████| 5000/5000 [02:30<00:00, 33.33只股票/s]
```

显示信息：
- 当前进度（百分比）
- 已下载/总数量
- 耗时时间
- 剩余时间
- 下载速度

## 日志文件

所有操作都会记录到日志文件 `download_all_stocks.log`，包括：
- 连接状态
- 下载进度
- 错误信息
- 最终统计结果

## 断点续传机制

脚本会自动保存已下载的股票列表到 `downloaded_stocks.json` 文件：
- 每次批次下载完成后自动保存
- 中断后可使用 `--resume` 恢复
- 避免重复下载已完成的股票

## 错误处理

1. **QMT连接断开**：自动尝试重连，最多重试3次
2. **单只股票下载失败**：记录到日志，跳过继续下载其他股票
3. **网络错误**：自动重试机制
4. **用户中断**：保存当前进度，可断点续传

## 性能优化建议

1. **批次大小**：网络好可增加到100-200，网络差建议50以下
2. **下载间隔**：网络拥堵时可增加到0.2-0.5秒
3. **建议下载时间**：非交易时间（9:00-15:30外）
4. **磁盘空间**：确保有足够空间存储所有数据

## 示例输出

```
============================================================
沪深A股全量历史数据下载工具
============================================================
日期范围: 20240901 到 20241216（共73个交易日）
数据周期: 1d
重试次数: 3
下载间隔: 0.1秒
批次大小: 50
✓ 获取到 5500 只股票
待下载股票数量: 5500

处理批次 1/110，共 50 只股票
批次 1 完成：成功 50, 失败 0

下载进度:  25%|████████████▌                    | 1375/5500 [00:45<02:15, 30.56只股票/s]
```

## 注意事项

1. **QMT要求**：
   - QMT客户端必须完全启动并登录
   - 建议以管理员权限运行QMT
   - 确保QMT行情权限充足

2. **下载时间**：
   - 全量下载沪深A股约需30分钟-2小时（取决于网络和QMT性能）
   - 建议在非交易时间运行

3. **磁盘空间**：
   - 日线数据约需2-5GB空间
   - 分钟线数据需更大空间（10GB+）

4. **网络稳定性**：
   - 建议在网络稳定的环境下运行
   - 如网络不稳定，可增加 `--delay` 参数

## 故障排除

**QMT连接失败**
```
✓ 连接成功！
```

**下载速度慢**
- 增加 `--delay` 参数到 0.3-0.5
- 减小 `--batch-size` 到 20-30

**部分股票下载失败**
- 检查日志文件了解失败原因
- 通常是网络问题，会自动重试
- 可重新运行 `--resume` 继续

**磁盘空间不足**
- 确保有足够空间
- 可分批下载，使用 `--days` 限制日期范围
